---
# Main playbook for Full-Stack Web Application Deployment

- name: Deploy Task Manager Application
  hosts: webservers
  become: true
  gather_facts: true
  vars:
    app_name: "Task Manager"
    app_version: "1.0.0"
    backend_port: 5000
    frontend_port: 80

  pre_tasks:
    - name: Display deployment information
      ansible.builtin.debug:
        msg:
          - "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          - "â•‘  Deploying {{ app_name }} v{{ app_version }}          "
          - "â•‘  Target: {{ inventory_hostname }}                      "
          - "â•‘  OS: {{ ansible_distribution }} {{ ansible_distribution_version }}"
          - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

    - name: Wait for system to be ready
      ansible.builtin.wait_for_connection:
        timeout: 300
        delay: 10

    - name: Gather all facts
      ansible.builtin.setup:

    - name: Update all packages
      ansible.builtin.yum:
        name: "*"
        state: latest
        update_cache: yes
      when: ansible_distribution == "Amazon"

    - name: Install EPEL repository
      ansible.builtin.yum:
        name:
          - epel-release
        state: present
      when: ansible_distribution == "Amazon"
      ignore_errors: true

  roles:
    - role: webapp
      tags: ["webapp", "fullstack"]

  post_tasks:
    - name: Verify backend service is running
      ansible.builtin.systemd:
        name: taskmanager-backend
        state: started
        enabled: yes

    - name: Verify Nginx is running
      ansible.builtin.service:
        name: nginx
        state: started
        enabled: yes

    - name: Test backend API health
      ansible.builtin.uri:
        url: "http://localhost:{{ backend_port }}/api/health"
        return_content: yes
        timeout: 10
      register: api_health
      retries: 5
      delay: 3
      until: api_health.status == 200

    - name: Test frontend availability
      ansible.builtin.uri:
        url: "http://localhost:{{ frontend_port }}"
        return_content: yes
        timeout: 10
      register: frontend_test
      retries: 3
      delay: 3
      until: frontend_test.status == 200

    - name: Get backend service status
      ansible.builtin.command: systemctl status taskmanager-backend --no-pager
      register: backend_status
      changed_when: false
      failed_when: false

    - name: Display deployment success
      ansible.builtin.debug:
        msg:
          - "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          - "â•‘            âœ“ DEPLOYMENT SUCCESSFUL! âœ“                  "
          - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - ""
          - "ğŸŒ Application URLs:"
          - "   Frontend:  http://{{ ansible_default_ipv4.address }}"
          - "   API:       http://{{ ansible_default_ipv4.address }}:{{ backend_port }}/api"
          - "   Health:    http://{{ ansible_default_ipv4.address }}:{{ backend_port }}/api/health"
          - ""
          - "ğŸ“Š Services Status:"
          - "   Backend:   {{ 'Running âœ“' if backend_status.rc == 0 else 'Failed âœ—' }}"
          - "   Frontend:  {{ 'Available âœ“' if frontend_test.status == 200 else 'Failed âœ—' }}"
          - "   Nginx:     Running âœ“"
          - ""
          - "ğŸ” Quick Tests:"
          - "   curl http://{{ ansible_default_ipv4.address }}"
          - "   curl http://{{ ansible_default_ipv4.address }}:5000/api/health"
          - "   curl http://{{ ansible_default_ipv4.address }}:5000/api/tasks"
          - ""
          - "ğŸ“ Logs Location:"
          - "   Backend:   /opt/taskmanager/logs/"
          - "   Nginx:     /var/log/nginx/"
          - ""
          - "âš™ï¸  Service Management:"
          - "   sudo systemctl status taskmanager-backend"
          - "   sudo systemctl restart taskmanager-backend"
          - "   sudo systemctl status nginx"

    - name: Create deployment info file
      ansible.builtin.copy:
        content: |
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘         Task Manager Application                       â•‘
          â•‘         Deployment Information                         â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

          Deployment Date: {{ ansible_date_time.iso8601 }}
          Server: {{ ansible_hostname }}
          IP Address: {{ ansible_default_ipv4.address }}
          OS: {{ ansible_distribution }} {{ ansible_distribution_version }}

          Application Details:
          - Name: {{ app_name }}
          - Version: {{ app_version }}
          - Frontend Port: {{ frontend_port }}
          - Backend Port: {{ backend_port }}

          URLs:
          - Frontend: http://{{ ansible_default_ipv4.address }}
          - API: http://{{ ansible_default_ipv4.address }}:{{ backend_port }}/api
          - Health Check: http://{{ ansible_default_ipv4.address }}:{{ backend_port }}/api/health

          Features:
          - âœ“ Full-Stack React + Flask application
          - âœ“ Task management with CRUD operations
          - âœ“ SQLite database
          - âœ“ RESTful API
          - âœ“ Responsive UI
          - âœ“ Real-time filtering and search
          - âœ“ Category and priority management

          Service Status:
          - Backend Service: Active
          - Nginx Service: Active
          - Database: SQLite (initialized)

          Log Files:
          - Backend: /opt/taskmanager/logs/backend.log
          - Access: /opt/taskmanager/logs/access.log
          - Errors: /opt/taskmanager/logs/error.log
          - Nginx Access: /var/log/nginx/taskmanager-access.log
          - Nginx Error: /var/log/nginx/taskmanager-error.log

          Management Commands:
          - Check backend: sudo systemctl status taskmanager-backend
          - Restart backend: sudo systemctl restart taskmanager-backend
          - Check nginx: sudo systemctl status nginx
          - View logs: sudo journalctl -u taskmanager-backend -f
          - Test API: curl http://localhost:5000/api/health

          Database:
          - Location: /opt/taskmanager/backend/tasks.db
          - Type: SQLite
          - Tables: tasks, categories

          Deployed by: Ansible
          Infrastructure: Terraform + Ansible

        dest: /opt/taskmanager/DEPLOYMENT_INFO.txt
        owner: ec2-user
        group: ec2-user
        mode: "0644"

  handlers:
    - name: reload systemd
      ansible.builtin.systemd:
        daemon_reload: yes

    - name: restart backend
      ansible.builtin.systemd:
        name: taskmanager-backend
        state: restarted

    - name: restart nginx
      ansible.builtin.service:
        name: nginx
        state: restarted

    - name: reload nginx
      ansible.builtin.service:
        name: nginx
        state: reloaded
