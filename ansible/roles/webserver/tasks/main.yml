---
# Full-Stack Web Application Deployment

- name: Install system dependencies
  ansible.builtin.yum:
    name:
      - python3
      - python3-pip
      - python3-devel
      - gcc
      - git
    state: present
    update_cache: yes

- name: Install Node.js 18.x
  ansible.builtin.shell: |
    curl -fsSL https://rpm.nodesource.com/setup_18.x | bash -
    yum install -y nodejs
  args:
    creates: /usr/bin/node

- name: Install Nginx
  ansible.builtin.yum:
    name: nginx
    state: present
    enablerepo: "*"

- name: Create application directory
  ansible.builtin.file:
    path: /opt/taskmanager
    state: directory
    owner: ec2-user
    group: ec2-user
    mode: "0755"

- name: Create subdirectories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: ec2-user
    group: ec2-user
    mode: "0755"
  loop:
    - /opt/taskmanager/backend
    - /opt/taskmanager/frontend
    - /opt/taskmanager/logs
    - /var/www/taskmanager

# Backend Deployment
- name: Copy backend app.py
  ansible.builtin.copy:
    src: ../../../app/backend/app.py
    dest: /opt/taskmanager/backend/app.py
    owner: ec2-user
    group: ec2-user
    mode: "0644"

- name: Copy backend requirements.txt
  ansible.builtin.copy:
    src: ../../../app/backend/requirements.txt
    dest: /opt/taskmanager/backend/requirements.txt
    owner: ec2-user
    group: ec2-user
    mode: "0644"

- name: Create Python virtual environment
  ansible.builtin.command:
    cmd: python3 -m venv /opt/taskmanager/backend/venv
    creates: /opt/taskmanager/backend/venv/bin/python
  become_user: ec2-user

- name: Upgrade pip in virtual environment
  ansible.builtin.pip:
    name: pip
    state: latest
    virtualenv: /opt/taskmanager/backend/venv
  become_user: ec2-user

- name: Install Python dependencies
  ansible.builtin.pip:
    requirements: /opt/taskmanager/backend/requirements.txt
    virtualenv: /opt/taskmanager/backend/venv
  become_user: ec2-user

- name: Create systemd service for backend
  ansible.builtin.template:
    src: backend.service.j2
    dest: /etc/systemd/system/taskmanager-backend.service
    owner: root
    group: root
    mode: "0644"
  notify:
    - reload systemd
    - restart backend

- name: Enable and start backend service
  ansible.builtin.systemd:
    name: taskmanager-backend
    enabled: yes
    state: started
    daemon_reload: yes

# Frontend Deployment
- name: Copy frontend source files
  ansible.builtin.copy:
    src: ../../../app/frontend/
    dest: /opt/taskmanager/frontend/
    owner: ec2-user
    group: ec2-user
    mode: preserve

- name: Install frontend dependencies
  ansible.builtin.command:
    cmd: npm install
    chdir: /opt/taskmanager/frontend
  become_user: ec2-user
  register: npm_install
  changed_when: npm_install.rc == 0

- name: Build React application
  ansible.builtin.command:
    cmd: npm run build
    chdir: /opt/taskmanager/frontend
  become_user: ec2-user
  register: npm_build
  changed_when: npm_build.rc == 0

- name: Copy build files to Nginx directory
  ansible.builtin.copy:
    src: /opt/taskmanager/frontend/build/
    dest: /var/www/taskmanager/
    remote_src: yes
    owner: nginx
    group: nginx
    mode: preserve

# Nginx Configuration
- name: Configure Nginx for application
  ansible.builtin.template:
    src: nginx-app.conf.j2
    dest: /etc/nginx/conf.d/taskmanager.conf
    owner: root
    group: root
    mode: "0644"
  notify: restart nginx

- name: Remove default Nginx configuration
  ansible.builtin.file:
    path: /etc/nginx/conf.d/default.conf
    state: absent
  notify: restart nginx

- name: Ensure Nginx is enabled and running
  ansible.builtin.service:
    name: nginx
    enabled: yes
    state: started

# Firewall Configuration
- name: Disable SELinux temporarily
  ansible.builtin.command: setenforce 0
  ignore_errors: yes
  changed_when: false

# Health Checks
- name: Wait for backend to be ready
  ansible.builtin.uri:
    url: http://localhost:5000/api/health
    status_code: 200
  register: backend_health
  until: backend_health.status == 200
  retries: 15
  delay: 5
  ignore_errors: yes

- name: Wait for frontend to be ready
  ansible.builtin.uri:
    url: http://localhost
    status_code: 200
  register: frontend_health
  until: frontend_health.status == 200
  retries: 10
  delay: 3
  ignore_errors: yes

- name: Display deployment information
  ansible.builtin.debug:
    msg:
      - "✓ Backend API: http://{{ ansible_default_ipv4.address }}:5000/api"
      - "✓ Frontend App: http://{{ ansible_default_ipv4.address }}"
      - "✓ Health Check: http://{{ ansible_default_ipv4.address }}:5000/api/health"
      - "✓ Application deployed successfully!"
